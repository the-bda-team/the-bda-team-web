<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>BibTeX to BDA Publications JSON</title>
<script src="https://cdn.jsdelivr.net/npm/bib2json@0.0.1/Parser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
<script> // Bibtex
const parsePeople = (value) => {
  return value
    .split(/\s+and\s+/i)
    .map(name => {
      name = name.trim();
      // Handle "Last, First"
      if (name.includes(",")) {
        return name.split(",").map(s => s.trim());
      }
      // Handle "First Last"
      const parts = name.split(/\s+/);
      return [
        parts.slice(0, -1).join(" "),
        parts.slice(-1)[0]
      ];
    });
}

const bibtexFieldParsers = {
  "author": parsePeople,
  "editors": parsePeople,
  "pages": (value) => {
    return value.replace(/-/g, "--");
  }
}


function bibtex2json(bibtex, logElement) {
  const categories = Object.fromEntries(
    schemas["publication"]["$defs"]["Publication"]["properties"]["category"]["enum"].map(
      category => [category.toLowerCase(), category]
    )
  );
  const entries = BibtexParser(bibtex).entries;
  const idCounts = {};
  const results = [];

  for (const e of entries) {
    const category = categories[e.EntryType.toLowerCase()];
    if (!category) {
      logElement.textContent += "\nIgnoring unknown entry type '" + e.EntryType + "'";
      continue;
    }

    const schema = JSON.parse(JSON.stringify(schemas["publication"]["$defs"]["Publication"]["properties"]));
    delete schema["id"];
    delete schema["category"];
    Object.assign(
      schema,
      schemas["publication"]["$defs"]["Publication"]["allOf"]
        .find(condition => (condition["if"]["properties"]["category"]["const"] == category))["then"]["properties"]
    );

    let id = parsePeople(e.Fields.author || e.Fields.editor)[0][1].toLowerCase().replace(/[^a-z]/g, "") + ":" + e.Fields.year;
    if (!idCounts[id]) { idCounts[id] = 0; }
    idCounts[id] += 1;
    id += String.fromCharCode(96 + idCounts[id]);
    const data = { id, category };

    for (const key of Object.keys(e.Fields)) {
      const normalizedKey = key.toLowerCase();
      if (schema[normalizedKey]) {
        let value = e.Fields[key];
        if (bibtexFieldParsers[normalizedKey]) {
          value = bibtexFieldParsers[normalizedKey](value);
        }
        data[normalizedKey] = value;
      }
    }
    console.log(data);
    results.push(data);
  }

  editor.setValue(results);
};
</script>
</head>
<body>

<textarea id="bibtex" rows="15" cols="80" placeholder="Paste BibTeX here..."></textarea>
<br><br>
<button id="convert">Convert to JSON</button>

<div id="editor_holder"></div>

<button id="submit">Get JSON from Form</button>

<pre id="output"></pre>

<script>
const schemas = {};
let editor = null;
document.getElementById("convert").addEventListener("click", () => {
  bibtex2json(document.getElementById("bibtex").value, document.getElementById("output"));
});

Promise.all([
  fetch("https://raw.githubusercontent.com/the-bda-team/the-bda-team-web/refs/heads/main/_schemas/publications.json"),
  fetch("https://raw.githubusercontent.com/the-bda-team/the-bda-team-web/refs/heads/main/_schemas/base.json")
]).then(async ([publicationResponse, baseResponse]) => {
  schemas["publication"] = await publicationResponse.json();
  schemas["base"] = await baseResponse.json();

  // 1. Initialize the Editor
  const element = document.getElementById('editor_holder');
  editor = new JSONEditor(element, {
    schema: schemas["publication"],
    refs: {
      "_schemas/base.json": schemas["base"]
    },
    display_required_only: true
  });
});

// 2. Function to get JSON object (Submit)
document.getElementById('submit').addEventListener('click', () => {
  const errors = editor.validate();
  editor.showValidationErrors();
  if (errors.length) {
    document.getElementById("output").textContent = JSON.stringify(errors, null, 2);
  } else {
    const data = editor.getValue();
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  }
});

</script>

</body>
</html>
